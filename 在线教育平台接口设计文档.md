# 在线教育平台设计文档

版本 | 日期 | 编辑 | 说明 
---|---|---|---
v1.0.0 | 2019-06-24 | 张小雄 | 第一次编辑
v1.0.1 | 2019-07-06 | 张小雄 | 第一次接口讨论会议后更新补充
v1.0.2 | 2019-07-19 | 安益民 | 数据库建表修改 


## 文档概述

### 文档范围
本文档旨在详细描述在线教育平台项目开发规范及技术设计细节，针对技术架构、数据库设计、接口、缓存等多个方面对开发过程进行详细描述及定义； 本文档主要阅读者包括项目产品经理、技术负责人、前后端开发人员、客户端开发人员、测试人员等；


### 架构说明
#### 开发技术
1. 后端开发采用Java Spring Clound开发框架
2. 后端数据接口采用Https通讯协议，服务器端基于TCP/IP协议长连接实现
3. 涉及地理位置信息和手环设备定时状态（如心率、体温等），以及消息历史记录，采用MongoDB
4. 业务数据库基于mysql，读写分离架构；
5. 缓存服务采用redis；
6. Web后台前端采用SGDMS
7. 移动前端开发采用Flutter

#### 物理服务器架构
1. 系统整体基于云端架构，具体使用阿里云/华为云
2. 以阿里云为例，需要的云服务器配置如下：
    - 数据库使用阿里云RDS数据库 1台
    - MongoDB 服务器 1台
    - Redis 服务器1台
    - ECS服务器1台
    - 阿里云短信服务接口
    - 阿里云HTTPS服务证书1个
    - 友盟消息推送服务

#### 产品模块

![功能模块](CBC4B0A5370243FDB5128D1D0A2820CF)


## 数据接口定义

### 运营总后台数据接口
#### 后台接口描述

运营总后台据接口地址为：http://xxx/manager/
接口采用REST API 风格，交互数据格式为JSON
所有请求，使用POST方法
所有接口返回值类型统一定义为：

```
{
    result_code:0,          //0-success,1-failure
    result_message:"xxxx"   //返回消息
    result_data:[{
        
    }]                      //json数据，约定如果返回的单条数据，也放在数据中
}
```

#### 接口清单

##### 关于用户

* 用户登录(user/login）

> 1. 管理员用户登录，管理员提交用户名和密码密文(md5)进行登录
> 2. 同一个IP，输错5次（参数）以上，锁定该账号1小时（参数）
> 3. 登录成功后，返回userid，及token，token为32位随机字符串

*请求参数*

```
    {
        "username":"xxxx",              //必填
        "password":"xxxxx"              //必填,密码前端md5加密传输
        "currentRoleId": 1              //当前选择登陆的角色
    }
```

*返回值*

```
{
    "result_code":0,                    //0-成功，1失败
    "result_message":"",                //失败原因，错误不返回
    "result_data":[{
        "userid":xxxx,
        "name":"xxxxx",             
        "token":"xxxxxxxxx"
    }]
}
```

##### 系统相关

* 用户管理(sys/account_list)

```
    //请求参数
    {
        "token":"xxxxxxxxx",              //必填,用户登录token
        "searchs":{
            "key1":"xxxxx",               //搜索条件1
            "key2":"xxxxx"
        },
        "pager":{
            "ps":25,                    //当前页大小
            "page":1                    //分页，需加载的页数
        },
        "order":" id desc"              //排序，默认id 倒序
    }
    
    //返回值
    {
        "result_code":0,                    //0-成功，1失败
        "result_message":"",                //失败原因，错误不返回
        "result_data":{
            "pager":{
                "ps":25,                    //当前页大小
                "page":1                    //分页，需加载的页数
            }
            "total": 10                     //总条数
            "rows":[{                       //行数据
                "id":1,
                "shoolId":1,
                "username":"admin1",
                "password":"1qaz2sxx",
                "phoneNo":123123,
                "statusFlag":0
            },{
                "id":2,
                "shoolId":2,
                "username":"admin2",
                "password":"1qaz2sxx",
                "phoneNo":123123433,
                "statusFlag":0
            }
            ........
            ]
        }
    }
```

* 添加用户(sys/account_add)

  ```
  //请求参数
  { 
      "shoolId": 111,
      "username": "name1"
      "password": "12312"
      "phoneNo": 152xxxx
      "statusFlag": 0
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 用户更新(sys/account_update)

  ```
  //请求参数
  { 
      "id": 1231
      "shoolId": 111,
      "username": "name2"
      "password": "54545"
      "phoneNo": 152xxxx
      "statusFlag": 0
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 用户禁用/启用(sys/account_status)

  ```
  //请求参数
  { 
      "id": 1231
      "statusFlag": 0
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 删除用户（sys/account_remove)

  ```
  //请求参数
  {
  	"managerIds":[1,2,3,4]
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 角色列表(sys/role_list)

  ```
  //请求参数
  {
  	"token":"xxxxxxxxx",              //必填,用户登录token
  	"searchs":{
  		"key1":"xxxxx",               //搜索条件1
  		"key2":"xxxxx"
  	},
  	"pager":{
  		"ps":25,                    //当前页大小
  		"page":1                    //分页，需加载的页数
  	},
  	"order":" id desc"              //排序，默认id 倒序
  }
  
  //返回值
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
      "result_data":{
          "pager":{
              "ps":25,                    //当前页大小
              "page":1                    //分页，需加载的页数
          }
      	"total": 10                     //总条数
      	"rows":[{                       //行数据
              "roleId":1
              "roleTitle":"管理员1"
      	},{
              "roleId":2
              "roleTitle":"管理员2"
      	}
      	........
      	]
      }
  }
  
  ```

* 操作菜单列表(sys/menu_list)

*请求参数*

```
    {
        "token":"xxxxxxxxx"              //必填,用户登录token
    }
```

*返回值*

```
"result_code":0,
"result_message":"",
"result_data":[{
	"id":1,
	"pid": 0
    "path": '/dashboard',
    "name": 'dashboard',
    "icon": 'dashboard',
    "children": [{
        "id":2,
        "pid": 1,
        "path": '/dashboard/analysis',
        "name": 'analysis',
        "exact": true,
      },
      {
      	"id":3,
		"pid": 1,
        "path": '/dashboard/monitor',
        "name": 'monitor',
        "exact": true,
      },
      {
      	"id":4,
		"pid": 1,
        "path": '/dashboard/workplace',
        "name": 'workplace',
        "exact": true,
      },
    ],
  }
  ....
]
```


* 可操作菜单获取（sys/action_list)

  ```
  //请求参数
  {
  	"token":"xxxxxxxxx",              //必填,用户登录token  默认从session中获取roleId  
  }
  
  //返回值
  {
      "result_code":0,
      "result_message":"",
      "result_data":[{
          "id":1,
          "pid": 0
          "path": '/dashboard',
          "name": 'dashboard',
          "icon": 'dashboard',
          "children": [{
              "id":2,
              "pid": 1,
              "path": '/dashboard/analysis',
              "name": 'analysis',
              "exact": true,
            },
            {
              "id":3,
              "pid": 1,
              "path": '/dashboard/monitor',
              "name": 'monitor',
              "exact": true,
            },
            {
              "id":4,
              "pid": 1,
              "path": '/dashboard/workplace',
              "name": 'workplace',
              "exact": true,
            },
          ],
        }
        ....
      ]
  }
  
  ```

* 角色信息获取（sys/role_select)

```
    //请求参数
    {
        "token":"xxxxxxxxx",              //必填,用户登录token  默认从session中获取roleId  
    }
    
    //返回值
    {
      	"result_code":0,
        "result_message":"",
        "result_data":[{
            {                       //行数据
            "roleId":1
            "roleTitle":"管理员1"
    	},{
            "roleId":2
            "roleTitle":"管理员2"
    	}
    	........
        ]
    
    }
```



* 角色权限管理(sys/role_save)

  ```
  //请求参数
  {
  	"roleId":111,
  	"menuIds":[1,2,3,4]
  }
  
  //
  //返回参数
  {
  	"result_code":0,                           //0-成功，1失败
      "result_message":"success",                //success/失败原因
  }
  ```


##### 设备管理

* 设备列表(device/list)
* 设备批量添加(device/batadd)
* 设备批量删除(device/remove)
* 设备信息更新(device/update)
* 单个设备信息获取(device/get)
* 单个设备实时信息获取(device/tracker)
* 单个设备历史轨迹获取(device/history)
* 多个设备实时位置获取(device/bat_tracker)
* 设备上线/离线状态更新(device/status)


##### 学校/机构管理
* 学校列表(school/list)
* 添加学校(school/add)
* 更新学校(school/update)
* 获取学校信息(school/get)
* 删除学校(school/remove)
* 手环设备安装统计(school/stat_device)
* 班级数量统计(school/stat_class)
* 学生数量统计(school/stat_students)
* 学生出勤统计(school/stat_students_check)
* 学校账号列表(school/account_list)
* 添加管理员账号（school/account_add)
* 管理员密码重置（school/account_reset)

##### 会员管理

* 会员列表(member/list)
* 会员禁用/启用(member/status)
* 单个会员积分明细(member/points)
* 单个会员信息(member/get)
* 单个会员统计(member/get_stat)
* 会员总数统计(member/stat_total)
* 活跃会员统计(member/stat_top)

##### 报警信息管理


##### 积分商城


### 学校后台数据接口
#### 学校后台数据接口描述
    学校后台数据接口地址：http://xxx/school/
    接口采用REST API 风格，交互数据格式为JSON
    所有请求，使用POST方法
    所有接口返回值类型统一定义为：

```
{
    result_code:0,          //0-success,1-failure
    result_message:"xxxx"   //返回消息
    result_data:[{
        
    }]                      //json数据，约定如果返回的单条数据，也放在数据中
}
```

#### 接口清单
##### 关于用户

* 用户登录(user/login）
* 找回密码(user/resetpwd)

##### 系统和账号相关

* 用户管理(sys/account_list)
* 添加用户(sys/account_add)
* 用户更新(sys/account_update)
* 用户禁用/启用(sys/account_status)
* 删除用户（sys/account_remove)
* 角色列表(sys/role_list)
* 操作菜单列表(sys/all_menu)
* 系统操作列表 (sys/all_action)
* 角色信息获取（sys/get_role)
* 角色权限管理(sys/role_save)

##### 教师管理

* 教师列表(teacher/list)

  ```
  //请求参数
  {
  	"token":"xxxxxxxxx",              //必填,用户登录token
  	"searchs":{
  		"key1":"xxxxx",               //搜索条件1
  		"key2":"xxxxx"
  	},
  	"pager":{
  		"ps":25,                    //当前页大小
  		"page":1                    //分页，需加载的页数
  	},
  	"order":" id desc"              //排序，默认id 倒序
  }
  
  //返回值
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
      "result_data":{
          "pager":{
              "ps":25,                    //当前页大小
              "page":1                    //分页，需加载的页数
          }
      	"total": 10                     //总条数
      	"rows":[{
              "roleId":1
              "roleTitle":"管理员1"
      	},{
              "roleId":2
              "roleTitle":"管理员2"
      	}
      	........
      	]
      }
  }
  
  ```

* 添加教师(teacher/add)

  ```
  //请求参数
  { 
      "teacherId": 111,
      "schoolId":111,
      "teacherName": "12312",
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 教师资料更新(teacher/update)

  ```
  //请求参数
  { 
      "teacherId": 111,
      "schoolId":222,
      "teacherName": "4343",
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 教师资料删除（teacher/remove)

  ```
  //请求参数
  {
  	"teacherIds":[1,2,3,4]
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
  }
  ```

* 单个教师信息获取(teacher/get)

  ```
  //请求参数
  {
  	"id":[1,2,3,4]
  }
  //返回参数
  {
  	"result_code":0,                    //0-成功，1失败
      "result_message":"",                //失败原因，错误不返回
      "result_data":{
          "teacherId":111,
          "schoolId":111,
          "schoolName":"dasda",
          "teacherName":"dasda"
      }
  }
  ```


##### 学校/机构相关
* 基本信息获取(info/get)
* 基本信息维护(info/update)

##### 统计相关

* 手环设备安装统计(stat/stat_device)
* 班级数量统计(stat/class)
* 学生数量统计(stat/students)
* 学生出勤统计(stat/students_check)
* 历史出勤统计(stat/history_check)
* ......

##### 班级相关
* 班级列表(class/list)
* 添加班级(class/add)
* 更新班级信息(class/update)
* 删除班级信息(class/remove)
* 年级列表(grade/list)
* 添加年级(grade/add)
* 更新年级信息(grade/update)
* 删除年级信息(grade/remove)

##### 课表相关 

* 获取课表(timetable/list)
* 导入课表(timetable/import)

##### 学生相关
* 学生列表(students/lists)
* 导入学生信息(students/import)
* 学生信息更新(students/update)
* 删除学生信息(students/remove)

*接口说明*
> 1. 删除操作，用来将学生该学生从当前学校、当前班级删除，非彻底删除

* 添加学生信息(students/add)

* 学生手环实时数据(students/get_data)

### APP数据接口

#### 学校后台数据接口描述
    学校后台数据接口地址：http://xxx/api/
    接口采用REST API 风格，交互数据格式为JSON
    所有请求，使用POST方法
    所有接口返回值类型统一定义为：

```
{
    result_code:0,          //0-success,1-failure
    result_message:"xxxx"   //返回消息
    result_data:[{
        
    }]                      //json数据，约定如果返回的单条数据，也放在数据中
}
```
#### 接口清单

##### 用户相关
* 用户注册(user/register)
* 用户登录(user/login)
* 短信验证码(user/smscode)
* 个人资料(user/profile)

##### 手环相关
* 获取当前绑定的所有手环及实时信息(device/all)
* 获取单个手环实时信息(device/get)
* 绑定手环(device/checkqrcode)
> 根据手环二维码，获取相应的设备号，以便进行绑定

* 完成绑定(deivce/bind)
> 根据手环设备号、以及提交的学生信息，完成绑定流程

* 手环分享(device/share)

##### 家庭管理相关
* 家庭成员列表(family/list)
* 设置管理员(family/manager)
* 添加成员(family/add)
* 删除成员(family/remove)
* 邀请成员(family/invite)

##### 班级相关

* 班级成员(class/students)
* 班级列表(class/lists)
* 班级基本信息(class/info)
* 班级课表(class/timetable)
* 班级通知(class/notice)
* 发布通知(class/publish)
* 班级出勤统计(class/check_stat)
* 学生信息获取(students/get)
* 学生手环实时信息获取(students/status)

##### 积分商城相关
##### 其它接口

* 固件升级(sys/device_version)
* APP升级(sys/app_version)
* 文件下载(sys/download)
  
### Server端数据接口
#### Server端接口描述

    Server端采用TCP/IP协议

#### 接口清单
##### 设备上报接口协议
* 心跳包协议
* 获取天气协议
* 位置信息上报
* 盲点补传
* 同步时间
* 报警数据上报
* 拍照上传
* 生成二维码
* 解绑
* 上传体温数据
* 上传心率数据
* 上传蓝牙mac地址
* 语音消息
* 文字消息

##### 服务器下发指令协议

## 数据库设计

### 数据库设计规范
1. 数据表名及字段名统一采用26个英文字母小写，加"_"组成；
2. 数据表名采用 "前缀_"形式命名，如sg_；
3. 数据表名命名简洁，多个单词使用"_"分开，如"user_role"；
4. 每个表都必须至少有一个自增字段，命名统一为 "id"，数据类型-int(11)，且创建主键索引; 
5. 所有时间类型字段，均采用时间戳存储形式，精确到秒（部分字段如需精确天毫秒，单独增加一个int(4）字段表示毫秒值），数据类型-int(11); 
6. 不同表之间，相互关联的字段，字段名尽量一致；
7. 数据库引擎采用InnoDB；
8. 数据库采用utf8编码创建,所有字符串型字段编码统一为utf8_general_ci

### 数据表定义

#### 系统相关

* 管理员表(manager)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 为空 
---|---|---|---|---|---
id | int | 自增，主键,| 是 | | 否
school_id | int，关联school表| 是 | 0 | 否|
username | varchar(50) | 用户名 | 是 | | 否
password | varchar(50) | 密码 |  | | 是
phone | varchar(50) | 手机号 | 否 | | 是

* 管理员角色表(manager_role)

| 字段       | 数据类型           | 字段说明     | 是否索引 | 默认值 | 为空 |
| ---------- | ------------------ | ------------ | -------- | ------ | ---- |
| id         | int                | 自增，主键,  | 是       |        | 否   |
| manager_id | int，关联manager表 | 管理员id     | 0        | 否     | 否   |
| role_id    | int，关联role表    | 拥有的角色id | 否       |        | 否   |

* 角色表(role)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 为空 
---|---|---|---|---|---
id | int | 自增，主键,| 是 | | 否
~~school_id~~ | int，关联school表| 是 | 0 | 否|
title | varchar(50) | 角色名称 | 否 | | 否

* 角色授权表(role_rights)

| 字段        | 数据类型            | 字段说明     | 是否索引 | 默认值 | 为空 |
| ----------- | ------------------- | ------------ | -------- | ------ | ---- |
| id          | int                 | 自增，主键,  | 是       |        | 否   |
| role_id     | int，关联role表     | 角色id       | 0        | 否     | 否   |
| sys_menu_id | int，关联sys_menu表 | 拥有的菜单id | 否       |        | 否   |

* 系统菜单表(sys_menu)

| 字段  | 数据类型     | 字段说明    | 是否索引 | 默认值 | 为空 |
| ----- | ------------ | ----------- | -------- | ------ | ---- |
| id    | int          | 自增，主键, | 是       |        | 否   |
| title | varchar(50)  | 菜单名字    | 0        | 否     | 否   |
| menu  | varchar(255) | 菜单内容    | 否       |        | 否   |

#### 设备相关
* 设备表(device)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 为空 |
---|---|---|---|---|---
SN | varchar(20) | 主键 | 是 | '' | 否
createtime | bigint(11) | 入库时间 | 否 | | 否
devicetype | varchar(10) | 设备类型 | 是 | BRACELET（手环） | 否 |
model | varchar(50) | 设备型号，如xx手环1代等级 | 是 |  |  是

* 设备学生绑定表(device_students)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
SN | varchar(20) | 手环设备号 | 是 | '' | 否
students_id | int | 学生id号 | 是 | 0 | 否
bind_time | bigint(11) | 时间戳，手环绑定时间 | 否 | | 否


* 设备用户（家长）绑定表(device_account)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
students_id | int | 学生id | 是 | '' | 否
account_id | int | 会员id,对应account表 | 是 | 0 | 否
phone | varchar(20) | 手机号 | 
bind_time | bigint(11) | 时间戳，手环绑定时间 | 否 | | 否
ismanager | bit | 是否管理员，0-非管理员，1-管理员，一个手环只有一个管理员 | 是 | 0 | 否
relation | varchar(10) | 与宝宝的关系，从数据字典中取| 否 | '爸爸' | 否
headimage | binary | 二进制，头像照片数据 


#### 会员相关
* 会员表(account)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
username | varchar(20) | 用户名，直接用手机号 | 是 |  | 否
password | varchar(50) | 密码，md5 | 否 | | 是
score | int | 总积分值 | 否 | 0 | 否
email | varchar(50) | email，暂时不用 | 否 |  | 是
catetory_id | int | 会员类型，对应account_category表 | 是 | 0 | 否

* 会员积分表(account_score)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
account_id | int | 会员id,对应accont表 | 是 | 0 | 否
score | int | 分值 | 否 | 0 | 否
score_time | bigint(11) | 计分时间 | 否 |  | 否
description | varchar(100) | 描述，说明计分原因 | 否 | | 是

* 会员类型(account_category)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
title | varchar(50) | 会员类型名称 | 否 |  | 是

* 会员详细资料表(account_detail)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
account_id | int | 会员id,对应accont表 | 是 | 0 | 否
name | varchar(50) | 姓名 | 否 | | 否 |
phone | varchar(20) | 电话 | 否 | | |
address | varchar(255) | 地址 | 否 | | 是 |

#### 学校/机构相关

* 学校表(school)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
title | varchar(100) | 学校/机构名称 | 否 | | 否 |
simple_title | varchar(20) | 简称  | 否 | | 是  |
address | varchar(255) | 地址 | 否 | | 是 |
lon | decimal(6,4) | gps坐标，经度 |  否 | | 否
lat | decimal(6,4) | gps坐标，纬度 | 否 | | 否 |
description | text | 学校图文介绍 |
linkman | varchar(20) | 联系人姓名  | 否 |  | 是
phone | varchar(20) | 联系电话  | 否  | | 是
email | varchar(50) | 管理员email，用来接收账号信息 | 否 | | 是 

* 班级表(class)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
title | varchar(50) | 班级名称，如一年级3班 | 否 | | 否 |
school_id | int | 所属学校 | 是 | | 否 |
account_id | int | 班主任用户id | 是 | | 否

* 学生表(students)

字段 | 数据类型 | 字段说明 | 是否索引 | 默认值 | 可为空 |
---|---|---|---|---|---
id | int | 主键，自增 | 是 | 0 | 否
name | varchar(50) | 学生姓名| 否 | | 否 |
sex | varchar(4) | 性别 | 是 | | 否 |
school_id | int | 所属学校 | 是 | | 否 |
class_id | int |所属班级 | 是 | | 否 |
cardno | varchar(50) | 身份证号 | 是 | |  |
registerno | varchar(50) | 学籍号  | 是 | | 是|
nickname | varchar(50) | 昵称 | 否 | | 是|

* 课表(timetable)

* 教师表(teacher)

### 其它

* 推送消息(message)

```
{
    "type":'',
    "body":'',              //消息体，html格式
    "data_id":xxxx,         //关联的相关业务数据表id
    "url":"xxxxx",          //消息处理业务地址或activity
    "send_time":xxxxx,      //发送时间
    "update_time":xxxx      //处理时间
    "status":""             //处理状态
}
```

* 文章类型(article)

### 非关系型数据存储（Mongo)

* 设备绑定二维码(bind_code)

> 设备绑定二维码为32位随机字符，服务器端收到终端请求后生成，生成时，保存生成时间、过期时间等，默认used字段为0，验证后（不管是否成功），设置为1

```
{
    "SN":"xxxx",
    "code":"xxxxxxx",
    "create_time":xxxxx,
    "invalid_time":xxxxx,
    "used":0
}
```

* 定位数据集(gps)
```
{
    "SN":xxxxx,                 //设备号
    "time":xxxx,                //时间
    "lon":139.12,               //纬度
    "lat":44.22,                //经度
    "direct":"xxx",             //方向
    ...
}
```
* 即时通信消息数据(message)

* 健康状况数据(health)

```
{
    "SN":xxxxx,                 //设备号
    "time":xxxx,                //时间
    "value":139.12              //数据值
    ...
}
```

* 设备分享及邀请(shareandjoin)
```
    {
        "account_id":1,             //邀请人id
        "account_name":"xxx",       //邀请人姓名
        "phone":"xxx",              //被邀请人手机号
        "share_time":xxxxxxx,       //邀请时间
        "invalide_time":xxxx,       //邀请过期时间
        "famiy_group_id":xxxx,      //家庭群组id
        "device_students_id":xxxx   //设备与学生的id
    }
```

* 会员登录(account_logon)
```
{
    "account_id":1,
    "login_ip":"xxx.xxx.xx.xx",
    "login_time":xxxxxxxx,
    "token":"xxxxxxxxxxxx"
}
```
* 短信验证码(smscode)
```
{
    "phone":xxx,
    "code":"415621",
    "send_time":xxxxxxxx,   //时间戳
    "invalid_time":xxxxxx   //时间戳
    "used":0
}
```
* 家庭群组(family_group)
```
{
    "id":xxxx,
    "title":"xxx家庭群",
    "create_time":xxxxx,
    "members":[
        "students":[{
          "student_id":xxxx,                //对应的学生id，无学生信息即为0
          "device_students_id":xxx,         //学生与设备绑定id,无绑定设备，则为0
          "name":"xxx",                      //对应的姓名
          "sex":"男"                         //性别
          "headimage":''                    //头像
        }],
        "account":[{
            "account_id":xxx,            //对应account个id
            "name":"xxx",                   //姓名或关系名称，如爸爸，妈妈等
            "phone":"xxxxxx",
            "ismanager":1               //是否管理员
        }]
    ]
}
```

* 班级群组(class_group)

```
{
    "id":xxxx,
    "title":"一年级3班",
    "create_time":xxxx,
    "members":[{
        "students":[{
            "student_id":xxx,           //学生id
            "name":"学生姓名",
            "sex":"男/女",
            "tag":"班长"                //班级内标签
        },
        "account":[{
            "account_id":xxx,
            "name":"xxx",
            "phone":"xxxx",
            "tag":"班主任",            //群组内标签
            "ismanager":1               //0/1
        }]
    }]
}
```

* 安全区域(security_area)


## 缓存定义

## 主要业务流程

### 设备绑定

![设备绑定流程](FE5D9D44E0E9422BB7BEB341993A4551)

> 流程说明：
> 1. 二维码的生成，由设备按协议请求服务器，服务器生成后发送至设备； 
> 2. 手机端扫描二维码后，向API请求所对应设备的设备号，如果设备号获取失败，则说明该二维码失效； 
> 3. 用户填写完成学生身份信息后，提交至API，由API端获取相应的学生id，获取成功，开始绑定学生与设备、设备与家长
> 4.  绑定成功后，通过Server端向手环发送绑定成功的消息，由手环处理流程
> 5. 绑定成功后，自动创建一个 绑定账号id且为管理员、手环用户的家庭群组

### 添加家庭成员

![邀请成员链接](0A6B31968D5C4B9E8A26514C22DDF60A)

> 流程说明：
> 1. 如果被邀请人为已注册用户，向该用户发送消息通知，用户同意后即可加入
> 2. 如果被邀请人未注册，生成APP下载链接，并附邀请码，用户使用被邀请手机号注册并登录成功后，自动加入群组，并绑定与设备学生的关系

### 添加学校流程

> 流程说明：
>
> 1. 学校添加成功后，自动创建关联学校id的管理员账号，用户名统一为:admin，密码随机生成，管理员账号创建成功后，通过email将学校id，用户名，密码信息发送至管理员


### 添加班级流程

## 系统参数设置


### 运营平台参数


* 安全设置
  
> 1. 管理员登录错误锁定次数
> 2. 管理员登录错误锁定时长(单位s)
> 3. 短信验证码过期时长(单位s)
> 4. 设备二维码过期时长(单位s)

### 学校后台参数