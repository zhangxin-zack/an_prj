<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scorer.client.dao.mysql_dao1.ManagerDao">

    <resultMap id="manager" type="com.scorer.client.entity.Manager">
        <result column="id" property="id"/>
        <result column="school_id" property="schoolId"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="phone" property="phoneNo"/>
        <result column="status_flag" property="statusFlag"/>
    </resultMap>

    <resultMap id="role" type="com.scorer.client.entity.Role">
        <result column="id" property="roleId"/>
        <result column="title" property="roleTitle"/>
    </resultMap>

    <resultMap id="menu" type="com.scorer.client.entity.Menu">
        <result column="id" property="menuId"/>
        <result column="pid" property="menuPid"/>
        <result column="title" property="menuTitle"/>
        <result column="path" property="path"/>
        <result column="icon" property="icon"/>
    </resultMap>

    <select id="login" resultMap="manager">
        SELECT
            m.id,
            m.school_id,
            m.username,
            m.PASSWORD,
            phone
        FROM
            manager m
        WHERE
            m.username = #{username}
            AND m.password = #{password}
    </select>

    <select id="getManagerCount" resultType="long">
        SELECT count(id)
        FROM manager
        WHERE 1 = 1
    </select>

    <select id="getManagerList" resultMap="manager">
        SELECT
        id,
        school_id,
        username,
        password,
        phone
        FROM manager
        WHERE 1 = 1
        <if test="searchs.username!=null and searchs.username!=''">
            AND username LIKE CONCAT('%',#{searchs.username},'%')
        </if>
        <foreach collection="sort" index="index" item="item" open="ORDER BY" separator=",">
            ${item.field} ${item['type']}
        </foreach>
        LIMIT #{startIndex}, #{pageSize}
    </select>

    <insert id="addManager">
        <selectKey resultType="Long" keyColumn="id" keyProperty="id" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into manager(school_id, username,password,phone,status_flag)
        values (#{schoolId}, #{username},#{password},#{phoneNo},#{statusFlag})
    </insert>

    <insert id="addManagerRole">
        INSERT INTO manager_role (manager_id, role_id)
        VALUES (#{0}, #{1})
    </insert>

    <delete id="deleteManagerRole">
        DELETE FROM manager_role
        WHERE manager_id = #{id}
    </delete>

    <delete id="deleteManagersRole">
        DELETE FROM manager_role
        WHERE manager_id in
        <foreach collection="list" item="ManagerId" open="(" separator="," close=")">
            #{ManagerId}
        </foreach>
    </delete>

    <update id="updateManager">
        update manager
        <set>
            <if test="schoolId!= null and schoolId != 0 ">
                school_id = #{schoolId},
            </if>
            <if test="username!= null and username!= '' ">
                username = #{username},
            </if>
            <if test="password!= null and password!= '' ">
                password = #{password},
            </if>
            <if test="phoneNo!= null and phoneNo!= '' ">
                phone = #{phoneNo},
            </if>
            <if test="statusFlag!= null">
                status_flag = #{statusFlag},
            </if>
        </set>
        where id = #{id}
    </update>

    <delete id="deleteManager">
        delete from manager where id in
        <foreach collection="list" item="ManagerId" open="(" separator="," close=")">
            #{ManagerId}
        </foreach>
    </delete>

    <select id="getRoleCount" resultType="long">
        SELECT count(id)
        FROM role
        WHERE 1 = 1
    </select>

    <select id="getRoleList" resultMap="role">
        SELECT
            id,
            title
        FROM role
        WHERE 1 = 1
        <if test="searchs.roleTitle!=null and searchs.roleTitle!=''">
            AND title LIKE CONCAT('%',#{searchs.roleTitle},'%')
        </if>
        <foreach collection="sort" index="index" item="item" open="ORDER BY" separator=",">
            ${item.field} ${item['type']}
        </foreach>
        LIMIT #{startIndex}, #{pageSize}
    </select>

    <insert id="addRole">
        INSERT INTO role (title) VALUES (#{roleTitle})
    </insert>

    <delete id="deleteRole">
        delete from role where id in
        <foreach collection="list" item="roleId" open="(" separator="," close=")">
            #{roleId}
        </foreach>
    </delete>

    <update id="updateRole">
        update role
        <set>
            <if test="roleTitle!= null and roleTitle != '' ">
                title = #{roleTitle},
            </if>
        </set>
        where id = #{id}
    </update>

    <delete id="deleteManagersRoleByRoleIds">
        DELETE FROM manager_role
        WHERE role_id in
        <foreach collection="list" item="roleId" open="(" separator="," close=")">
            #{roleId}
        </foreach>
    </delete>

    <delete id="deleteRoleMenuByRoleIds">
        DELETE FROM role_rights
        WHERE role_id in
        <foreach collection="list" item="roleId" open="(" separator="," close=")">
            #{roleId}
        </foreach>
    </delete>

    <delete id="deleteRoleMenuByMenuIds">
        DELETE FROM role_rights
        WHERE sys_menu_id in
        <foreach collection="list" item="menuId" open="(" separator="," close=")">
            #{menuId}
        </foreach>
    </delete>

    <insert id="addMenu">
        INSERT INTO sys_menu (pid, title, path, icon) VALUES (#{menuPid}, #{menuTitle}, #{path}, #{icon})
    </insert>

    <delete id="deleteMenus">
        delete from sys_menu where id in
        <foreach collection="list" item="menuId" open="(" separator="," close=")">
            #{menuId}
        </foreach>
    </delete>

    <update id="updateMenu">
        update sys_menu
        <set>
            <if test="menuTitle!= null and menuTitle != '' ">
                title = #{menuTitle},
            </if>
            <if test="path!= null and path != '' ">
                path = #{path},
            </if>
            <if test="icon!= null and icon != '' ">
                icon = #{icon},
            </if>
        </set>
        where id = #{id}
    </update>


    <select id="getAllRoleList" resultMap="role">
        SELECT
            id,
            title
        FROM role
    </select>

    <insert id="addRoleMenu">
        INSERT INTO role_rights (role_id, sys_menu_id)
        VALUES (#{0}, #{1})
    </insert>

    <delete id="deleteRoleMenu">
        DELETE FROM role_rights
        WHERE role_id = #{id}
    </delete>

    <select id="getAllMenuList" resultMap="menu">
        SELECT
            m.id,
            m.pid,
            m.path,
            m.title,
            m.icon
        FROM sys_menu m
    </select>

    <select id="getActionMenuList" resultMap="menu">
        SELECT
            m.id,
            m.pid,
            m.path,
            m.title,
            m.icon
        FROM
            sys_menu m
            JOIN role_rights rr ON m.id = rr.sys_menu_id
            JOIN role r ON rr.role_id = r.id
        WHERE
            role_id = #{roleId}
    </select>
</mapper>